generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  createdAt    DateTime      @default(now())
  templates    Template[]
  publications Publication[]
}

model Template {
  id          String      @id @default(cuid())
  ownerId     String
  owner       User        @relation(fields: [ownerId], references: [id])

  name        String
  description String?

  // NEW: friendly authoring spec (FormSpec JSONB)
  formSpec    Json

  // (Optional legacy; can remove later if unused)
  schema      Json?
  uiSchema    Json?

  version     Int         @default(1)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  publications Publication[]
}

model Publication {
  id          String      @id @default(cuid())
  ownerId     String
  owner       User        @relation(fields: [ownerId], references: [id])

  templateId  String
  template    Template    @relation(fields: [templateId], references: [id])

  title       String
  schema      Json        // compiled snapshot (JSONB)
  uiSchema    Json?
  createdAt   DateTime    @default(now())

  shareLinks  ShareLink[]
  submissions Submission[]
}

model ShareLink {
  id            String       @id @default(cuid())
  publicationId String
  publication   Publication  @relation(fields: [publicationId], references: [id])
  token         String       @unique
  isDisabled    Boolean      @default(false)
  assignedName  String?
  assignedEmail String?
  note          String?
  createdAt     DateTime     @default(now())

  submissions   Submission[]
}

model Submission {
  id            String       @id @default(cuid())
  publicationId String
  publication   Publication  @relation(fields: [publicationId], references: [id])

  shareLinkId   String?
  shareLink     ShareLink?   @relation(fields: [shareLinkId], references: [id])

  payload       Json         // JSONB
  meta          Json?
  createdAt     DateTime     @default(now())

  @@index([publicationId, createdAt])
}
